#!/bin/sh

## Copyright (C) 2012   A. Gordon (gordon at cshl dot edu)
## License: @LICENSE@

##
## Helper script to copy the given file (or current directory)
## to the clipboard, in rsync-ready format.
##

die()
{
    BASE=$(basename -- "$0")
    echo "$BASE: error: $@" >&2
    exit 1
}

usage()
{
	BASE=$(basename $0)
	echo "
rsx - Copy file/dir name to clipboard, in RSYNC format.
Version: @VERSION@

Copyright (C) 2012, A. Gordon ( gordon at cshl dot edu )
License: @LICENSE@

Usage:
  $BASE
  $BASE [FILE-or-DIRECTORY]

Will copy the full path of the specified file/directory (or current directory)
and the current hostname into the clipboard, in a format compatible
with RSYNC ( rsync://user@hostname.domain/full/path/to/file ).

Then it can be easily pasted into a command line.

Example:
  $BASE myfile.txt

  Assuming the user is 'bob', the hostname is 'foobar.cshl.edu',
  and the current directory is '/home/bob/documents/',
  the program will copy the following string into the clipboard:
     rsync://bob@foobar.cshl.edu/home/bob/documents/myfile.txt

Note:
1. Requires 'xsel' program to be installed
2. Requires a valid X11-forwarding setting

"

    exit
}

test "x$1" = "x-h" || test "x$1" = "--help" && usage

if [ -z "$1" ]; then
	# No parameter: copy current directory to clipboard
	FULLPATH=$PWD
else
	# Got a command-line parameter: assume it's a file name
	test -e "$1" || die "File '$1' not found!"

	# Resolve the absolute path in a portable way
	FULLPATH=$(perl -MCwd -e '$f=Cwd::realpath($ARGV[0]);
                                  die unless -e $f; print $f' -- "$1") \
                  die "failed to resolve absolute path of '$1'"
fi

FQDN=$(hostname -f)

printf "rsync://$USER@${FQDN}${FULLPATH}" | xsel -b
